<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Financial Analyzer</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
<div id="root" class="max-w-7xl mx-auto p-6"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

// --- Icon Components ---
const IconKey = () => (
  <svg className="h-4 w-4 text-gray-400 mr-1" fill="none" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/>
    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke="currentColor" strokeWidth="2"/>
  </svg>
);
const IconChart = () => (
  <svg className="h-4 w-4 text-blue-400 mr-1" fill="none" viewBox="0 0 24 24">
    <path d="M4 20V10M12 20V4M20 20V14" stroke="currentColor" strokeWidth="2"/>
  </svg>
);
const IconLLM = () => (
  <svg className="h-4 w-4 text-purple-400 mr-1" fill="none" viewBox="0 0 24 24">
    <rect x="4" y="4" width="16" height="16" stroke="currentColor" strokeWidth="2"/>
    <circle cx="12" cy="12" r="3" stroke="currentColor" strokeWidth="2"/>
  </svg>
);
const IconPipeline = () => (
  <svg className="h-4 w-4 text-green-400 mr-1" fill="none" viewBox="0 0 24 24">
    <rect x="4" y="10" width="16" height="4" stroke="currentColor" strokeWidth="2"/>
    <circle cx="8" cy="12" r="2" stroke="currentColor" strokeWidth="2"/>
    <circle cx="16" cy="12" r="2" stroke="currentColor" strokeWidth="2"/>
  </svg>
);
const IconSpinner = () => (
  <svg className="animate-spin h-5 w-5 mr-2 text-blue-500" viewBox="0 0 24 24" fill="none">
    <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
  </svg>
);

// --- Sidebar Components ---
function AnalysisConfig({ company, setCompany, year, setYear, reportType, setReportType, isRunning, onStart }) {
  return (
    <div className="bg-white rounded-lg shadow p-4 mb-4">
      <div className="flex items-center font-semibold mb-2">
        <IconKey />
        Analysis Configuration
      </div>
      <div className="mb-2">
        <label className="block text-xs text-gray-500">Company Name or Ticker</label>
        <input
          className="border px-2 py-1 rounded w-full"
          value={company}
          onChange={e => setCompany(e.target.value)}
          disabled={isRunning}
        />
      </div>
      <div className="flex gap-2 mb-2">
        <div className="flex-1">
          <label className="block text-xs text-gray-500">Year</label>
          <select
            className="border px-2 py-1 rounded w-full"
            value={year}
            onChange={e => setYear(e.target.value)}
            disabled={isRunning}
          >
            {[2025,2024,2023,2022,2021].map(y => (
              <option key={y} value={y}>{y}</option>
            ))}
          </select>
        </div>
        <div className="flex-1">
          <label className="block text-xs text-gray-500">Report Type</label>
          <select
            className="border px-2 py-1 rounded w-full"
            value={reportType}
            onChange={e => setReportType(e.target.value)}
            disabled={isRunning}
          >
            <option value="kpi_bullet_insights">KPI Insights</option>
          </select>
        </div>
      </div>
      <button
        className="w-full py-2 bg-indigo-600 text-white rounded font-semibold flex items-center justify-center"
        onClick={onStart}
        disabled={isRunning}
      >
        {isRunning ? <IconSpinner /> : "Start Analysis"}
      </button>
    </div>
  );
}
function LLMUsage({ llmCalls }) {
  return (
    <div className="bg-white rounded-lg shadow p-4 mb-4">
      <div className="flex items-center font-semibold mb-2">
        <IconLLM />
        LLM Usage
      </div>
      <div className="text-xs text-gray-500">
        {llmCalls === 0 ? "No LLM calls yet." : `${llmCalls} LLM call${llmCalls > 1 ? "s" : ""} made.`}
      </div>
    </div>
  );
}
function PipelineKPIs({ kpis, reportUrl }) {
  return (
    <div className="bg-white rounded-lg shadow p-4">
      <div className="flex items-center font-semibold mb-2">
        <IconPipeline />
        Pipeline KPIs
      </div>
      <div className="text-xs">
        <div className="flex justify-between"><span>End-to-End Latency:</span> <span>{kpis.latency.toFixed(2)}s</span></div>
        <div className="flex justify-between"><span>Total LLM Tokens:</span> <span>{kpis.tokens}</span></div>
        <div className="flex justify-between"><span>Estimated LLM Cost:</span> <span>${kpis.cost.toFixed(5)}</span></div>
        <div className="flex justify-between"><span>Tool Call Success:</span> <span>{kpis.toolSuccess ?? "N/A"}</span></div>
        <div className="flex justify-between"><span>Pipeline Errors:</span> <span>{kpis.errors}</span></div>
        <div className="flex justify-between mt-2 text-gray-400"><span>LLM-as-Judge Metrics (Post-run)</span></div>
        <div className="flex justify-between"><span>Answer Relevance:</span> <span>{kpis.relevance ?? "N/A"}</span></div>
        <div className="flex justify-between"><span>Faithfulness:</span> <span>{kpis.faithfulness ?? "N/A"}</span></div>
      </div>
      
      {reportUrl && (
        <a 
          href={reportUrl} 
          className="mt-3 block py-2 bg-green-600 text-white text-center rounded hover:bg-green-700"
          download
        >
          Download Report
        </a>
      )}
    </div>
  );
}

// --- Main Area Components ---
function AgentToolTable({ agentSteps }) {
  return (
    <div className="bg-white rounded-lg shadow p-4 mb-4">
      <div className="font-semibold mb-2">Agent &amp; Tool Execution</div>
      <table className="min-w-full text-xs">
        <thead>
          <tr className="border-b">
            <th className="text-left py-1">AGENT</th>
            <th className="text-left py-1">TOOL</th>
            <th className="text-left py-1">STATUS</th>
            <th className="text-left py-1">DURATION</th>
          </tr>
        </thead>
        <tbody>
          {agentSteps.length === 0 ? (
            <tr>
              <td colSpan={4} className="py-2 text-gray-400 text-center">No agent steps yet.</td>
            </tr>
          ) : (
            agentSteps.map((step, i) => (
              <tr key={i} className="border-b last:border-0">
                <td>{step.agentName}</td>
                <td>{step.toolName}</td>
                <td>
                  {step.status === "Running" && <span className="text-blue-600">Running</span>}
                  {step.status === "Completed" && <span className="text-green-600">Completed</span>}
                  {step.status === "Error" && <span className="text-red-600">Error</span>}
                </td>
                <td>{step.duration ? `${step.duration.toFixed(0)} ms` : "..."}</td>
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  );
}
function RawEventLog({ log }) {
  return (
    <div className="bg-gray-900 rounded-lg shadow p-4 text-xs text-white font-mono h-40 overflow-y-auto">
      <div className="flex gap-4 mb-1">
        <span className="font-semibold text-gray-300">Raw</span>
        <span className="font-semibold text-gray-300">Event</span>
        <span className="font-semibold text-gray-300">Log</span>
      </div>
      <div>
        {log.length === 0
          ? <div className="text-gray-500">No events yet.</div>
          : log.map((line, i) => <div key={i}>{line}</div>)
        }
      </div>
    </div>
  );
}

// --- Main App ---
function App() {
  // State
  const [company, setCompany] = useState("Microsoft");
  const [year, setYear] = useState("2024");
  const [reportType, setReportType] = useState("kpi_bullet_insights");
  const [isRunning, setIsRunning] = useState(false);
  const [error, setError] = useState(null);
  const [reportUrl, setReportUrl] = useState(null);

  // Real-time state
  const [agentSteps, setAgentSteps] = useState([]);
  const [log, setLog] = useState([]);
  const [llmCalls, setLlmCalls] = useState(0);
  const [kpis, setKpis] = useState({
    latency: 0,
    tokens: 0,
    cost: 0,
    toolSuccess: "N/A",
    errors: 0,
    relevance: "N/A",
    faithfulness: "N/A"
  });

  // Ref for EventSource connection
  const eventSourceRef = useRef(null);

  // Cleanup on unmount
  useEffect(() => {
    return () => {
      if (eventSourceRef.current) {
        eventSourceRef.current.close();
      }
    };
  }, []);

  // Start analysis with real backend
  function startAnalysis() {
    setIsRunning(true);
    setError(null);
    setAgentSteps([]);
    setLog([]);
    setLlmCalls(0);
    setReportUrl(null);
    setKpis({
      latency: 0,
      tokens: 0,
      cost: 0,
      toolSuccess: "N/A",
      errors: 0,
      relevance: "N/A",
      faithfulness: "N/A"
    });

    // Create SSE connection to backend
    const eventSource = new EventSource(
      `/stream?company=${encodeURIComponent(company)}&year=${year}&report_type=${reportType}`
    );
    eventSourceRef.current = eventSource;

    eventSource.onmessage = (event) => {
      try {
        const eventData = JSON.parse(event.data);
        setLog(prev => [...prev, event.data]); // Add raw event to log

        // Process different event types
        switch(eventData.event_type) {
          case 'agent_start':
            setAgentSteps(prev => [
              ...prev, 
              {
                agentName: eventData.data.agent_name,
                toolName: 'Processing...',
                status: 'Running',
                duration: null
              }
            ]);
            break;
            
          case 'agent_end':
            setAgentSteps(prev => prev.map(step => 
              step.agentName === eventData.data.agent_name
                ? { ...step, status: 'Completed', duration: eventData.data.agent_latency_ms }
                : step
            ));
            break;
            
          case 'tool_result':
            setAgentSteps(prev => prev.map(step => 
              step.agentName === eventData.data.agent_name
                ? { 
                    ...step, 
                    toolName: eventData.data.tool_name,
                    status: eventData.data.success ? 'Completed' : 'Error',
                    duration: eventData.data.tool_latency_ms
                  }
                : step
            ));
            setKpis(prev => ({
              ...prev,
              tool_calls: (prev.tool_calls || 0) + 1,
              successful_tool_calls: (prev.successful_tool_calls || 0) + (eventData.data.success ? 1 : 0)
            }));
            break;
            
          case 'llm_metrics':
            setLlmCalls(prev => prev + 1);
            setKpis(prev => ({
              ...prev,
              tokens: prev.tokens + (eventData.data.tokens || 0),
              cost: prev.cost + (eventData.data.cost || 0)
            }));
            break;
            
          case 'pipeline_end':
            setKpis(prev => ({
              ...prev,
              latency: eventData.data.end_to_end_latency_ms / 1000
            }));
            // Extract report URL from final output
            if (eventData.data.final_output) {
              const match = eventData.data.final_output.match(/report available at: (.*)/i);
              if (match && match[1]) {
                setReportUrl(match[1]);
              }
            }
            break;
            
          case 'evaluation_metric':
            if (eventData.data.metric_name === 'Answer Relevance') {
              setKpis(prev => ({ ...prev, relevance: eventData.data.score }));
            }
            if (eventData.data.metric_name === 'Faithfulness') {
              setKpis(prev => ({ ...prev, faithfulness: eventData.data.score }));
            }
            break;
            
          case 'pipeline_error':
            setError(eventData.data.error || "Pipeline error occurred");
            setKpis(prev => ({
              ...prev,
              errors: prev.errors + 1
            }));
            break;
        }
      } catch (e) {
        console.error("Error parsing event:", e);
      }
    };

    eventSource.onerror = () => {
      setError("Connection to server failed");
      setIsRunning(false);
      eventSource.close();
    };

    // Handle pipeline completion
    eventSource.addEventListener('pipeline_complete', () => {
      setIsRunning(false);
      eventSource.close();
    });
  }

  return (
    <div>
      <h1 className="text-2xl font-bold mb-6">Financial Analyzer</h1>
      <div className="flex flex-col md:flex-row gap-6">
        {/* Sidebar */}
        <div className="md:w-1/3 flex flex-col gap-4">
          <AnalysisConfig
            company={company}
            setCompany={setCompany}
            year={year}
            setYear={setYear}
            reportType={reportType}
            setReportType={setReportType}
            isRunning={isRunning}
            onStart={startAnalysis}
          />
          <LLMUsage llmCalls={llmCalls} />
          <PipelineKPIs kpis={kpis} reportUrl={reportUrl} />
        </div>
        {/* Main area */}
        <div className="md:w-2/3 flex flex-col gap-4">
          <AgentToolTable agentSteps={agentSteps} />
          <RawEventLog log={log} />
        </div>
      </div>
      {error && <div className="mt-4 text-red-600">{error}</div>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
